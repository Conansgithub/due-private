# 项目上下文

## 目的
due 是一个基于 Go 语言开发的轻量级、高性能分布式游戏服务器框架。旨在为游戏服务器开发提供完善、高效、优雅、标准化的解决方案。框架已在多个企业级游戏项目中上线实践,具备充分的稳定性保障。

## 技术栈
- **语言**: Go 1.23.0+
- **架构**: 分布式微服务架构
- **核心组件**:
  - Gate(网关): TCP、KCP、WebSocket 服务器
  - Node(节点服务): 核心业务逻辑,支持有状态/无状态模式
  - Mesh(微服务): 无状态业务服务
  - Client(客户端): 测试与调试客户端
- **通信协议**: gRPC、RPCX
- **注册中心**: Consul、Etcd、Nacos
- **配置中心**: Consul、Etcd、Nacos (支持 JSON、YAML、TOML、XML)
- **事件总线**: Redis、NATS、Kafka、RabbitMQ
- **缓存**: Redis、Memcache
- **加密**: RSA、ECC
- **日志**: Zap、Logrus、Aliyun、Tencent
- **序列化**: JSON、Protobuf、Msgpack
- **分布式锁**: Redis、Memcache
- **Actor 模型**: 内置完善的 Actor 模型实现

## 项目约定

### 代码风格
- 遵循标准 Go 代码规范和最佳实践
- 使用 gofmt 和 golint 进行代码格式化和静态检查
- 包命名使用小写,避免下划线和驼峰
- 接口命名以 -er 结尾(如 Locator、Registry)
- 导出函数和类型使用大写字母开头,非导出使用小写字母开头
- 错误处理:明确返回错误,避免 panic
- 注释:导出的类型、函数、常量必须添加文档注释

### 架构模式
- **模块化设计**: 借鉴 kratos 的模块设计思路,每个功能模块独立,可插拔
- **组件化**: 通过 Container 容器统一管理组件生命周期
- **接口驱动**: 核心功能通过接口定义,支持多种实现(如注册中心、配置中心)
- **Options 模式**: 使用函数式选项模式配置组件
- **中间件模式**: 支持请求处理中间件链
- **Actor 模型**: 用于有状态节点的并发处理
- **服务发现**: 通过注册中心实现动态服务发现和负载均衡
- **用户定位**: 通过 Locator 实现分布式环境下的用户会话定位
- **路由分发**: Gate 接收客户端消息并路由到对应 Node 节点

### 通信协议格式
采用 `size + header + route + seq + message` 的二进制协议:
- `size`: 4 字节包长度
- `header`: 1 字节(含心跳标识位和扩展操作码)
- `route`: 1/2/4 字节消息路由(默认 2 字节)
- `seq`: 0/1/2/4 字节消息序列号(默认 2 字节)
- `message`: 变长消息数据

### 测试策略
- 为核心功能模块编写单元测试
- 使用 Go 标准库 testing 包进行测试
- 测试文件命名为 `*_test.go`
- 追求关键路径的测试覆盖,而非单纯追求覆盖率数字
- 提供内置客户端用于集成测试和全流程调试

### Git 工作流程
- 主分支: `main`
- 开发分支: `develop` 或功能分支 `feature/*`
- 提交信息格式:
  - `feat:` 新功能
  - `fix:` 错误修复
  - `chore:` 构建过程或辅助工具的变动
  - `docs:` 文档更新
  - `refactor:` 重构(既不是新增功能,也不是修复 bug)
  - `test:` 增加测试
  - `perf:` 性能优化
- 使用语义化版本号(如 v2.5.0)
- 每个正式版本通过 Release 发布,并附带 commit 号

## 领域上下文

### 游戏服务器架构
- **Gate-Node 分离**: Gate 管理连接,Node 处理业务,实现关注点分离
- **有状态 vs 无状态**:
  - 有状态 Node: 维护玩家会话状态,不能随意重启
  - 无状态 Mesh: 可随时扩容缩容,适合无状态业务
- **平滑重启**: 通过信号量和服务注册中心控制实现零停机更新
- **动态扩容**: 通过路由分发机制支持水平扩展
- **用户定位**: 在分布式环境下快速定位用户所在节点

### 核心概念
- **Route(路由)**: 消息路由标识,用于区分不同的业务处理流程
- **Session(会话)**: 客户端连接的会话抽象
- **Proxy(代理)**: 各组件暴露的操作代理对象
- **Hook(钩子)**: 组件生命周期钩子
- **Event(事件)**: 组件事件监听机制
- **Middleware(中间件)**: 请求处理中间件
- **Locator(定位器)**: 用户位置定位服务
- **Registry(注册中心)**: 服务注册与发现
- **Transporter(传输层)**: RPC 传输抽象

## 重要约束
- **性能要求**: 框架设计追求高性能,单线程目标 TPS 20W+
- **稳定性要求**: 所有正式版本必须经过严格测试
- **向后兼容**: 尽量保持 API 向后兼容,重大变更提升大版本号
- **简洁性**: 架构简单,源码易理解,降低开发者心智负担
- **标准化**: 提供标准化的开发规范和项目结构
- **模块化**: 各子模块独立维护版本,保持与主模块版本一致性

## 外部依赖
- **服务注册中心**: Consul / Etcd / Nacos (至少需要一个)
- **用户定位服务**: Redis (用于 Locator)
- **配置中心**: Consul / Etcd / Nacos / 文件系统
- **事件总线**: Redis / NATS / Kafka / RabbitMQ (可选)
- **缓存服务**: Redis / Memcache (可选)
- **数据库**: 根据业务需求选择(框架不强制)
- **监控**: 可集成 Prometheus 等监控系统
- **日志收集**: 支持阿里云、腾讯云日志服务

## 开发工具
- **脚手架**: [due-cli](https://github.com/Conansgithub/due-cli) - 快速构建集群项目
- **代码生成**:
  - protoc-gen-go: Protobuf 代码生成
  - protoc-gen-go-grpc: gRPC 代码生成
  - protoc-gen-rpcx: RPCX 代码生成
  - gorm-dao-generator: GORM DAO 生成
  - mongo-dao-generator: MongoDB DAO 生成
